# ============================================================================
# RAPTOR v2.1.1 - ENSEMBLE ANALYSIS CONFIGURATION
# ============================================================================
# 
# This configuration is optimized for ensemble analysis - combining results
# from multiple RNA-seq pipelines for robust differential expression detection.
#
# Perfect for:
# - High-stakes analyses requiring maximum confidence
# - Discordant results between pipelines
# - Meta-analysis across studies
# - Identifying robust biomarkers
# - Clinical/diagnostic applications
#
# NEW in v2.1.1: Adaptive Threshold Optimizer integration for data-driven
# threshold selection across all pipelines in the ensemble.
#
# Strategy: Run multiple pipelines and combine results using statistical
# consensus methods to identify genes consistently called across methods.
#
# Usage: raptor ensemble --counts data.csv --config config_ensemble.yaml
# ============================================================================

# ============================================================================
# GENERAL SETTINGS
# ============================================================================
general:
  version: "2.1.1"
  verbose: true
  log_level: "INFO"
  output_dir: "./ensemble_analysis"
  random_seed: 42

# ============================================================================
# COMPUTATIONAL RESOURCES - ENSEMBLE REQUIRES MORE
# ============================================================================
resources:
  # Ensemble analysis runs multiple pipelines
  default_threads: 12
  default_memory_gb: 48
  max_threads: 24
  max_memory_gb: 96
  
  # Resource allocation
  ensemble_analysis:
    threads: 16
    memory_gb: 64
    
    # Parallel pipeline execution
    parallel_pipelines: true
    max_parallel: 4  # Run 4 pipelines simultaneously

# ============================================================================
# DATA PROFILING
# ============================================================================
profiling:
  bcv_thresholds:
    very_low: 0.2
    low: 0.4
    moderate: 0.6
    high: 0.8
  
  depth_categories:
    low: 10
    moderate: 30
    high: 50
  
  sample_size:
    small: 6
    medium: 12
    large: 20
  
  # Standard filtering
  min_counts_per_gene: 10
  min_samples_per_gene: 3
  filter_low_counts: true
  
  generate_plots: true
  save_profile: true

# ============================================================================
# ML RECOMMENDATION - SELECT DIVERSE PIPELINES
# ============================================================================
ml_recommendation:
  enabled: true
  model_type: "random_forest"
  
  prediction:
    # Get top 5 recommendations for diversity
    top_n_recommendations: 5
    confidence_threshold: 0.6  # Lower threshold for ensemble
    
    # Prioritize diversity over single best
    diversity_mode: true
    
  # Document why each pipeline was selected
  explain_predictions: true
  feature_importance: true

# ============================================================================
# ADAPTIVE THRESHOLD OPTIMIZER - ENSEMBLE MODE (NEW in v2.1.1)
# ============================================================================
# Use ATO to determine optimal thresholds for ensemble analysis
# Can apply same thresholds across all pipelines or optimize per-pipeline
# ============================================================================
threshold_optimizer:
  enabled: true
  
  # Use validation goal for ensemble (maximize confidence)
  goal: "validation"  # More stringent for high-confidence results
  
  # Ensemble-specific settings
  ensemble_mode:
    enabled: true
    
    # Apply same thresholds to all pipelines (recommended for fair comparison)
    uniform_thresholds: true
    
    # Or optimize per-pipeline (more liberal)
    per_pipeline_optimization: false
    
    # Combine π₀ estimates across pipelines
    combine_pi0: true
    pi0_combination_method: "median"  # median, mean, weighted
  
  # P-value adjustment - use stringent methods for ensemble
  padj_methods:
    benjamini_hochberg: true
    benjamini_yekutieli: true  # Good for correlated pipelines
    storey_qvalue: true
    holm: true                  # FWER for validation
    bonferroni: true
  
  # LogFC optimization
  logfc_methods:
    auto: true
    mad: true
    mixture: true
    power: true
    percentile: true
  
  default_logfc_method: "auto"
  
  # Comprehensive comparison for ensemble
  comparison:
    enabled: true
    logfc_values: [0.5, 0.75, 1.0, 1.5, 2.0]
    padj_values: [0.001, 0.01, 0.05]
    generate_heatmap: true
  
  # Visualization
  visualization:
    volcano_plot: true
    logfc_distribution: true
    pvalue_distribution: true
    threshold_heatmap: true
    optimization_summary: true
    
    # Ensemble-specific plots
    per_pipeline_comparison: true
    threshold_consistency: true
    
    plot_format: "png"
    dpi: 300
  
  output:
    save_optimized_results: true
    save_significant_genes: true
    generate_methods_text: true
    export_formats: ["csv", "xlsx"]

# ============================================================================
# QUALITY ASSESSMENT
# ============================================================================
quality_assessment:
  enabled: true
  
  metrics:
    - "library_size"
    - "detected_genes"
    - "mitochondrial_content"
    - "mapping_rate"
  
  thresholds:
    min_library_size: 1e6
    min_detected_genes: 5000
    max_mitochondrial_pct: 10
    min_mapping_rate: 70
  
  # Batch effect check is critical for ensemble
  batch_detection:
    enabled: true
    method: "pca"
  
  generate_qc_report: true

# ============================================================================
# ENSEMBLE PIPELINE STRATEGY - CORE CONFIGURATION
# ============================================================================
ensemble:
  enabled: true  # This is the main feature
  
  # ========================================================================
  # PIPELINE SELECTION
  # ========================================================================
  
  # Automatic pipeline selection
  auto_select: true  # Use ML to select best pipelines
  
  # Or manually specify pipelines
  manual_pipelines: []  # e.g., [1, 3, 5, 7] for specific combinations
  # Pipeline reference:
  # 1: STAR-RSEM-DESeq2
  # 2: STAR-RSEM-edgeR
  # 3: Salmon-edgeR
  # 4: Salmon-DESeq2
  # 5: kallisto-sleuth
  # 6: HISAT2-StringTie-Ballgown
  # 7: Salmon-limma
  # 8: STAR-RSEM-limma
  
  # Pipeline diversity
  ensure_diversity: true
  diversity_criteria:
    - "alignment_method"     # STAR vs Salmon vs kallisto
    - "quantification_method"  # RSEM vs Salmon vs kallisto
    - "de_method"           # DESeq2 vs edgeR vs limma
  
  # Number of pipelines to run
  min_pipelines: 3
  max_pipelines: 6  # Balance between robustness and computation
  optimal_pipelines: 5  # Target number
  
  # ========================================================================
  # ENSEMBLE METHODS
  # ========================================================================
  
  methods:
    # Use all methods for comprehensive analysis
    - "rank_aggregation"      # Combine gene rankings
    - "vote_counting"         # Majority vote (simple, robust)
    - "weighted_average"      # Weight by pipeline performance
    - "meta_analysis"         # Statistical combination (most rigorous)
    - "intersection"          # Most conservative (all must agree)
    - "union"                 # Most liberal (any can call)
  
  # Primary method for final calls
  primary_method: "meta_analysis"
  
  # ========================================================================
  # RANK AGGREGATION SETTINGS
  # ========================================================================
  rank_aggregation:
    method: "borda"  # borda, copeland, robust_rank_aggregation
    
    # Borda count: Assign points by rank
    borda:
      scoring: "linear"  # linear, exponential, logarithmic
    
    # Robust Rank Aggregation (RRA)
    rra:
      alpha: 0.05
      adjust_method: "BH"
  
  # ========================================================================
  # VOTE COUNTING SETTINGS
  # ========================================================================
  vote_counting:
    # Threshold for calling a gene DE
    vote_threshold: 0.6  # 60% of pipelines must agree
    
    # Weighted voting based on pipeline performance
    weighted: true
    
    # Confidence levels
    confidence_levels:
      high: 0.8      # 80% agreement = high confidence
      medium: 0.6    # 60% agreement = medium confidence
      low: 0.4       # 40% agreement = low confidence
  
  # ========================================================================
  # WEIGHTED AVERAGE SETTINGS
  # ========================================================================
  weighting:
    method: "performance_based"  # performance_based, ml_confidence, equal, custom
    
    # Performance metric for weighting
    performance_metric: "f1_score"  # f1_score, accuracy, precision, recall
    
    # ML confidence weighting
    ml_confidence:
      use_prediction_confidence: true
      confidence_weight: 0.3  # 30% from ML confidence
      performance_weight: 0.7  # 70% from benchmark performance
    
    # Custom weights (if method="custom")
    custom_weights: {}  # e.g., {1: 1.2, 3: 1.0, 5: 0.8}
    
    # Normalization
    normalize_weights: true
  
  # ========================================================================
  # META-ANALYSIS SETTINGS - MOST RIGOROUS
  # ========================================================================
  meta_analysis:
    # Statistical combination method
    method: "fishers"  # fishers, stouffers, weighted_z, random_effects
    
    # Fisher's method: Combine p-values
    fishers:
      adjust_method: "BH"
      adjust_per_comparison: true
    
    # Stouffer's Z-score method
    stouffers:
      weighted: true
      weights: "inverse_variance"
    
    # Random effects model (accounts for between-pipeline heterogeneity)
    random_effects:
      estimator: "DerSimonian-Laird"  # DL, REML, PM
      heterogeneity_test: true
      i_squared_threshold: 50  # High heterogeneity if I² > 50%
    
    # Effect size combination
    combine_effect_sizes: true
    effect_size_method: "weighted_average"
    
    # P-value thresholds (use ATO-optimized if available)
    p_value_threshold: 0.05
    use_ato_thresholds: true  # NEW: Use ATO-optimized thresholds
    
    # Heterogeneity assessment
    assess_heterogeneity: true
  
  # ========================================================================
  # CONSENSUS THRESHOLDS
  # ========================================================================
  consensus:
    min_agreement: 0.6  # 60% of pipelines must agree
    strict_mode: false  # If true, require higher agreement
    
    # Direction consistency
    require_direction_consistency: true
    
    # Effect size consistency (NEW: can use ATO)
    effect_size_tolerance: 0.5  # Allow 0.5 log2FC difference
    use_ato_logfc: true  # Use ATO-optimized logFC threshold
  
  # ========================================================================
  # CONFIDENCE SCORING (ENHANCED in v2.1.1)
  # ========================================================================
  confidence_scoring:
    enabled: true
    
    # Factors for confidence calculation
    factors:
      - "agreement_level"           # How many pipelines agree?
      - "p_value_consistency"       # Are p-values similar?
      - "effect_size_consistency"   # Are log fold changes similar?
      - "pipeline_performance"      # Performance of agreeing pipelines
      - "ml_confidence"            # ML model confidence
      - "ato_support"              # NEW: ATO threshold consistency
    
    # Weights for each factor
    factor_weights:
      agreement_level: 0.25
      p_value_consistency: 0.15
      effect_size_consistency: 0.15
      pipeline_performance: 0.20
      ml_confidence: 0.10
      ato_support: 0.15           # NEW: Weight for ATO
    
    # Confidence categories
    categories:
      very_high: 0.9    # >90%
      high: 0.75        # 75-90%
      medium: 0.6       # 60-75%
      low: 0.4          # 40-60%
      very_low: 0.2     # <40%
  
  # ========================================================================
  # OUTPUT AND REPORTING
  # ========================================================================
  
  # Generate comprehensive ensemble report
  generate_ensemble_report: true
  
  # Compare methods
  compare_methods: true
  method_comparison_metrics:
    - "number_de_genes"
    - "overlap_percentage"
    - "concordance_score"
    - "runtime"
  
  # Visualizations
  plot_comparisons: true
  plots:
    - "venn_diagram"          # Overlap between pipelines
    - "upset_plot"            # Multi-way intersections
    - "concordance_heatmap"   # Pipeline agreement matrix
    - "rank_comparison"       # Gene rank correlations
    - "effect_size_comparison"  # Log fold change correlations
    - "p_value_comparison"    # P-value correlations
    - "confidence_distribution"  # Distribution of confidence scores
    - "method_comparison"     # Compare ensemble methods
    - "threshold_optimization"   # NEW: ATO results
  
  # Export formats
  export_formats:
    - "csv"      # Individual pipeline results
    - "tsv"      # Ensemble results
    - "xlsx"     # Multi-sheet workbook with all results
  
  # Detailed output files
  save_individual_results: true
  save_agreement_matrix: true
  save_confidence_scores: true
  save_discordance_analysis: true

# ============================================================================
# STATISTICAL ANALYSIS - CONSISTENT ACROSS PIPELINES
# ============================================================================
statistics:
  # Default thresholds (can be overridden by ATO)
  fdr_threshold: 0.05
  log_fold_change_threshold: 1.0
  p_value_threshold: 0.05
  adjustment_method: "BH"
  
  # Use Adaptive Threshold Optimizer (recommended for ensemble)
  use_adaptive_thresholds: true
  
  # Document all statistical tests
  document_tests: true

# ============================================================================
# PIPELINE SETTINGS
# ============================================================================
pipelines:
  # Don't auto-select single pipeline (ensemble will select multiple)
  auto_select: false
  
  # Pipeline timeout (ensemble takes longer)
  timeout: 10800  # 3 hours per pipeline
  
  # Retry settings
  retry_on_failure: true
  max_retries: 1  # One retry for failed pipelines
  
  # Continue on partial failure
  continue_on_pipeline_failure: true
  min_successful_pipelines: 3  # Need at least 3 to proceed

# ============================================================================
# RESOURCE MONITORING
# ============================================================================
resource_monitoring:
  enabled: true
  sampling_interval: 5.0
  
  track_metrics:
    - "cpu_percent"
    - "memory_percent"
    - "disk_io"
  
  # Monitor per-pipeline resources
  per_pipeline_tracking: true
  
  save_metrics: true
  generate_resource_report: true

# ============================================================================
# OUTPUT SETTINGS
# ============================================================================
output:
  formats:
    results: ["csv", "tsv", "xlsx"]
    plots: ["png", "pdf"]
    reports: ["html", "pdf"]
  
  # Organize by ensemble method
  organize_by_method: true
  
  # Keep all intermediate results
  keep_intermediate_files: true
  
  compress_outputs: true
  timestamp_files: true

# ============================================================================
# AUTOMATED REPORTING - ENSEMBLE FOCUSED (UPDATED v2.1.1)
# ============================================================================
automated_reporting:
  enabled: true
  formats: ["html", "pdf"]
  
  sections:
    - "executive_summary"
    - "ensemble_strategy"
    - "pipeline_selection"
    - "threshold_optimization"   # NEW in v2.1.1
    - "individual_results"
    - "ensemble_results"
    - "concordance_analysis"
    - "discordance_analysis"
    - "confidence_assessment"
    - "method_comparison"
    - "biological_interpretation"
    - "recommendations"
  
  # Biological interpretation of ensemble results
  interpretation:
    enabled: true
    databases: ["GO", "KEGG", "Reactome"]
  
  # Compare interpretations across methods
  compare_enrichments: true

# ============================================================================
# BENCHMARKING
# ============================================================================
benchmarking:
  # Benchmark ensemble performance
  mode: "comprehensive"
  
  # Compare ensemble to individual pipelines
  compare_to_individual: true
  
  metrics:
    - "execution_time"
    - "peak_memory"
    - "accuracy"
    - "sensitivity"
    - "specificity"
    - "f1_score"
  
  save_benchmarks: true

# ============================================================================
# ADVANCED ENSEMBLE FEATURES
# ============================================================================
advanced_ensemble:
  # Iterative refinement
  iterative_refinement:
    enabled: false
    max_iterations: 3
    convergence_threshold: 0.01
  
  # Bootstrap confidence intervals
  bootstrap:
    enabled: true
    n_bootstrap: 1000
    confidence_level: 0.95
  
  # Sensitivity analysis (includes ATO thresholds)
  sensitivity_analysis:
    enabled: true
    vary_parameters:
      - "vote_threshold"
      - "min_agreement"
      - "p_value_threshold"
      - "logfc_threshold"        # NEW: Test ATO-suggested values
  
  # Stability analysis
  stability_analysis:
    enabled: true
    subsample_pipelines: true
    n_subsamples: 100

# ============================================================================
# USAGE NOTES
# ============================================================================
# 
# ENSEMBLE ANALYSIS WORKFLOW (UPDATED for v2.1.1):
# 
# 1. Profile your data:
#    raptor profile --counts data.csv --config config_ensemble.yaml
# 
# 2. Run ensemble analysis (ATO runs automatically):
#    raptor ensemble --counts data.csv --config config_ensemble.yaml
# 
# 3. Review results:
#    - Check ensemble_report.html for overview
#    - Review ATO threshold recommendations
#    - Examine concordance plots for agreement levels
#    - Review confidence scores for each gene
#    - Investigate discordant genes
# 
# NEW in v2.1.1:
# - Adaptive Threshold Optimizer determines optimal thresholds
# - Uniform thresholds applied across all pipelines (fair comparison)
# - π₀ estimates combined across pipelines
# - ATO confidence integrated into ensemble scoring
# 
# INTERPRETATION GUIDE:
# 
# - Very High Confidence (>90% agreement): Use for clinical decisions
# - High Confidence (75-90%): Robust biomarkers
# - Medium Confidence (60-75%): Follow-up validation recommended
# - Low Confidence (<60%): Investigate discordance, may be false positives
# 
# COMPUTATIONAL REQUIREMENTS:
# 
# - RAM: 48-64 GB recommended (running 4-6 pipelines)
# - CPU: 12-16 cores optimal
# - Time: 2-6 hours typical (depends on data size)
# - Disk: 50-100 GB for intermediate files
# 
# ============================================================================
